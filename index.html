<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lume Pro - Multi-Channel</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 15px; margin: 0; }
        .container { max-width: 450px; margin: auto; background: #1e1e1e; padding: 20px; border-radius: 15px; border: 1px solid #333; position: relative; }
        #gearBtn { position: absolute; top: 15px; right: 15px; cursor: pointer; background: #333; padding: 8px; border-radius: 5px; z-index: 100; }
        .header { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .header h2 { color: #00e676; margin: 0; }
        .main-ui { display: table; width: 100%; border-spacing: 10px; }
        .ui-row { display: table-row; }
        .left-col { display: table-cell; width: 130px; vertical-align: top; }
        .right-col { display: table-cell; background: #000; border: 1px solid #444; border-radius: 10px; vertical-align: top; color: #00e676; padding: 15px; height: 180px; font-family: monospace; font-size: 13px; overflow: hidden; }
        button { cursor: pointer; font-weight: bold; border: none; border-radius: 8px; }
        .conn-btn { width: 100%; background: #00e676; color: black; padding: 18px; margin-bottom: 15px; font-size: 16px; }
        .ctrl-btn { background: #383838; color: white; padding: 20px 10px; width: 100%; margin-bottom: 10px; font-size: 14px; border: 1px solid #444; }
        .ctrl-btn:active { background: #00e676; color: black; }
        #adminPanel { display: none; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #333; }
        #log { height: 120px; background: #000; font-family: monospace; font-size: 11px; overflow-y: auto; margin-top: 10px; padding: 8px; color: #0f0; border: 1px solid #333; }
        .msg-line { border-bottom: 1px solid #222; padding: 2px 0; }
        .uuid-tag { color: #888; font-size: 10px; float: right; }
    </style>
</head>
<body>

<div class="container">
    <div id="gearBtn" onclick="toggleAdmin()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </div>

    <div class="header">
        <h2>Lume Pro</h2>
        <small id="status">Status: Disconnected</small>
    </div>

    <button class="conn-btn" id="connectBtn" onclick="doConnect()">Connect to Device</button>

    <div class="main-ui">
        <div class="ui-row">
            <div class="left-col">
                <button class="ctrl-btn" onclick="send('L')">MODE</button>
                <button class="ctrl-btn" onclick="send('U')">FREQ +</button>
                <button class="ctrl-btn" onclick="send('D')">FREQ -</button>
            </div>
            <div class="right-col" id="displayArea">
                <div style="opacity:0.5">Awaiting Multi-Stream...</div>
            </div>
        </div>
    </div>

    <div id="adminPanel">
        <input type="text" id="manualIn" style="width:70%; padding:10px; background:#000; color:#fff; border:1px solid #444;" placeholder="Raw cmd...">
        <button class="ctrl-btn" style="width:25%; padding:10px; margin:0;" onclick="sendManual()">SEND</button>
        <div id="log">Console ready...</div>
    </div>
</div>

<script>
    let writeChar = null;
    let server = null;
    
    // All service and characteristic UUIDs
    const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
    const RX_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
    const TX_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';
    const BATTERY_SERVICE = 0x180f;
    const HEALTH_SERVICE = 0x1813;
    const DEVICE_INFO_SERVICE = 0x180a;
    
    const CHARACTERISTIC_UUIDS = {
        batteryLevel: 0x2a19,
        freq: "22e39003-05c2-498b-ad14-675b63720953",
        mode: "22e39004-05c2-498b-ad14-675b63720953",
        energy: "22e39005-05c2-498b-ad14-675b63720953",
        gen: 0x2b3c,
        wfreq: "6e1b8cd5-93dd-43a6-8565-92aaba8e4569",
        lfreq: "6e1b8cd6-93dd-43a6-8565-92aaba8e4569",
        sfreq: "6e1b8cd7-93dd-43a6-8565-92aaba8e4569"
    };

    function toggleAdmin() {
        const p = document.getElementById('adminPanel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    async function doConnect() {
        try {
            log("Requesting Lume...");
            
            // Replaced 'acceptAllDevices: true' with specific filter
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'Lume Frag 03' }],
                optionalServices: [
                    UART_SERVICE,
                    BATTERY_SERVICE,
                    HEALTH_SERVICE,
                    DEVICE_INFO_SERVICE,
                    "6e1b8cd4-93dd-43a6-8565-92aaba8e4569" // Lume service
                ]
            });

            server = await device.gatt.connect();
            log("Connected to GATT server");
            
            // Setup UART service
            await setupUARTService();
            
            // Setup Battery service
            await setupBatteryService();
            
            // Setup Health service
            await setupHealthService();

            document.getElementById('status').innerText = "Status: Connected";
            document.getElementById('connectBtn').style.display = "none";
            log("=== All channels configured ===");
        } catch(e) { 
            log("Error: " + e.message); 
        }
    }

    async function setupUARTService() {
        try {
            const service = await server.getPrimaryService(UART_SERVICE);
            log("Found UART service");
            
            // Get write characteristic
            writeChar = await service.getCharacteristic(RX_UUID);
            log("Write characteristic ready");
            
            // Listen on TX
            await setupListener(service, TX_UUID, 'UART-TX');
            
            // Also try RX (some devices echo back)
            await setupListener(service, RX_UUID, 'UART-RX');
            
        } catch(e) { 
            log("UART service error: " + e.message); 
        }
    }

    async function setupBatteryService() {
        try {
            const service = await server.getPrimaryService(BATTERY_SERVICE);
            log("Found Battery service");
            
            // Battery Level
            await setupListener(service, CHARACTERISTIC_UUIDS.batteryLevel, 'Battery');
            
            // Frequency
            await setupListener(service, CHARACTERISTIC_UUIDS.freq, 'Frequency');
            
            // Mode
            await setupListener(service, CHARACTERISTIC_UUIDS.mode, 'Mode');
            
            // Energy
            await setupListener(service, CHARACTERISTIC_UUIDS.energy, 'Energy');
            
        } catch(e) { 
            log("Battery service error: " + e.message); 
        }
    }

    async function setupHealthService() {
        try {
            const service = await server.getPrimaryService(HEALTH_SERVICE);
            log("Found Health service");
            
            // General Activity
            await setupListener(service, CHARACTERISTIC_UUIDS.gen, 'Activity');
            
        } catch(e) { 
            log("Health service error: " + e.message); 
        }
    }

    async function setupListener(service, uuid, name) {
        try {
            const char = await service.getCharacteristic(uuid);
            if (char.properties.notify) {
                await char.startNotifications();
                char.addEventListener('characteristicvaluechanged', (event) => {
                    const decoded = new TextDecoder().decode(event.target.value);
                    // Only log to console, don't update display
                    log(`[${name}]: ${decoded}`);
                });
                log(`✓ Listening: ${name}`);
            } else {
                log(`× ${name} doesn't support notify`);
            }
        } catch(e) { 
            log(`× ${name} unavailable`); 
        }
    }

    function updateDisplay(text, source) {
        const area = document.getElementById('displayArea');
        const newLine = `<div class="msg-line"><span class="uuid-tag">${source}</span>${text}</div>`;
        area.innerHTML = newLine + area.innerHTML;
        
        // Keep only the last 6 messages
        const lines = area.getElementsByClassName('msg-line');
        if (lines.length > 6) { 
            area.removeChild(lines[lines.length-1]); 
        }
    }

    async function send(data) {
        if(!writeChar) return log("Not Connected");
        try {
            await writeChar.writeValueWithoutResponse(new TextEncoder().encode(data));
            log("Sent: " + data);
        } catch(e) { 
            log("Send Error: " + e.message); 
        }
    }

    function sendManual() {
        const input = document.getElementById('manualIn');
        send(input.value);
        input.value = "";
    }

    function log(msg) {
        const l = document.getElementById('log');
        const timestamp = new Date().toLocaleTimeString();
        l.innerHTML += `<div>[${timestamp}] ${msg}</div>`;
        l.scrollTop = l.scrollHeight;
    }
</script>
</body>
</html>
