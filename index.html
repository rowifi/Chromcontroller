<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lume Frag 03 Controller</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f8f9fa; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; color: var(--primary); }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-size: 16px; transition: opacity 0.2s; }
        .btn:disabled { background: #bdc3c7; }
        .btn-set { width: auto; padding: 8px 15px; margin-left: 5px; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 60%; }
        #console { background: #1e1e1e; color: #d4d4d4; height: 180px; overflow-y: auto; padding: 12px; font-family: 'Courier New', monospace; border-radius: 8px; font-size: 13px; margin-top: 10px; border: 1px solid #333; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .label { font-size: 12px; color: #7f8c8d; text-transform: uppercase; margin-bottom: 5px; display: block; }
        .value { font-size: 24px; font-weight: bold; color: var(--accent); }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="status-bar">
            <span>Lume Frag 03</span>
            <span id="status" style="color: #e74c3c;">● Disconnected</span>
        </div>
        <button id="connectBtn" class="btn">Connect via Bluetooth</button>
    </div>

    <div class="data-grid">
        <div class="card">
            <span class="label">Battery</span>
            <span class="value" id="battLevel">--</span><span class="value">%</span>
        </div>
        <div class="card">
            <span class="label">Current Mode</span>
            <span class="value" id="modeVal">--</span>
        </div>
    </div>

    <div class="card">
        <span class="label">Settings</span>
        <div style="margin-bottom: 15px;">
            <input type="number" id="freqInput" placeholder="Set Frequency">
            <button onclick="writeVal('freq')" class="btn btn-set">Update</button>
        </div>
        <div>
            <input type="number" id="energyInput" placeholder="Set Energy">
            <button onclick="writeVal('energy')" class="btn btn-set">Update</button>
        </div>
    </div>

    <div class="card">
        <span class="label">UART Activity</span>
        <div id="console"></div>
        <div style="margin-top: 10px; display: flex;">
            <input type="text" id="uartInput" placeholder="Command..." style="flex-grow: 1;">
            <button id="sendUartBtn" class="btn btn-set">Send</button>
        </div>
    </div>
</div>

<script>
    const SERVICE_UART = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
    const CHAR_RX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
    const CHAR_TX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
    const SERVICE_BATT = 0x180f;
    const CHAR_BATT = 0x2a19;
    
    // Custom Parameter UUIDs
    const CHAR_FREQ = "22e39003-05c2-498b-ad14-675b63720953";
    const CHAR_MODE = "22e39004-05c2-498b-ad14-675b63720953";
    const CHAR_ENERGY = "22e39005-05c2-498b-ad14-675b63720953";

    let device, server;
    let chars = {};

    document.getElementById('connectBtn').addEventListener('click', async () => {
        try {
            log("Searching for Lume Frag...");
            device = await navigator.bluetooth.requestDevice({
                filters: [{ name: 'Lume Frag 03' }],
                optionalServices: [SERVICE_UART, SERVICE_BATT]
            });

            log("Connecting...");
            server = await device.gatt.connect();
            document.getElementById('status').innerText = "● Connected";
            document.getElementById('status').style.color = "#2ecc71";
            document.getElementById('connectBtn').disabled = true;

            const uartSvc = await server.getPrimaryService(SERVICE_UART);
            const battSvc = await server.getPrimaryService(SERVICE_BATT);

            chars.rx = await uartSvc.getCharacteristic(CHAR_RX);
            chars.tx = await uartSvc.getCharacteristic(CHAR_TX);
            chars.freq = await uartSvc.getCharacteristic(CHAR_FREQ);
            chars.mode = await uartSvc.getCharacteristic(CHAR_MODE);
            chars.energy = await uartSvc.getCharacteristic(CHAR_ENERGY);
            chars.batt = await battSvc.getCharacteristic(CHAR_BATT);

            // Notifications
            await chars.tx.startNotifications();
            chars.tx.addEventListener('characteristicvaluechanged', (e) => {
                log("TX: " + new TextDecoder().decode(e.target.value));
            });

            await chars.batt.startNotifications();
            chars.batt.addEventListener('characteristicvaluechanged', (e) => {
                document.getElementById('battLevel').innerText = e.target.value.getUint8(0);
            });

            // Initial Reads
            const m = await chars.mode.readValue();
            document.getElementById('modeVal').innerText = m.getUint8(0);
            
            const b = await chars.batt.readValue();
            document.getElementById('battLevel').innerText = b.getUint8(0);

            log("All systems ready.");
        } catch (err) {
            log("Error: " + err);
        }
    });

    async function writeVal(type) {
        try {
            let val = document.getElementById(type + 'Input').value;
            await chars[type].writeValue(new Uint8Array([parseInt(val)]));
            log("Updated " + type + " to " + val);
        } catch (e) { log("Write failed: " + e); }
    }

    document.getElementById('sendUartBtn').addEventListener('click', async () => {
        let msg = document.getElementById('uartInput').value;
        await chars.rx.writeValue(new TextEncoder().encode(msg));
        log("Sent: " + msg);
        document.getElementById('uartInput').value = "";
    });

    function log(msg) {
        const c = document.getElementById('console');
        c.innerHTML += `<div>> ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
    }
</script>
</body>
</html>