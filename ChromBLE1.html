<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lume Frag 03 Controller</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; color: #333; }
        .card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; }
        button:disabled { background: #ccc; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        #console { background: #222; color: #0f0; height: 150px; overflow-y: auto; padding: 10px; font-family: monospace; border-radius: 4px; margin-top: 10px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    </style>
</head>
<body>

    <h2>Lume Frag 03 Web App</h2>

    <div class="card">
        <button id="connectBtn">Connect to Lume Frag</button>
        <span id="status">Status: Disconnected</span>
    </div>

    <div class="grid">
        <div class="card">
            <h3>Battery: <span id="battLevel">--</span>%</h3>
            <p>Mode: <span id="modeVal">--</span></p>
        </div>
        <div class="card">
            <h3>Parameters</h3>
            <label>Freq:</label> <input type="number" id="freqInput" placeholder="Value"> <button onclick="writeVal('freq')">Set</button><br><br>
            <label>Energy:</label> <input type="number" id="energyInput" placeholder="Value"> <button onclick="writeVal('energy')">Set</button>
        </div>
    </div>

    <div class="card">
        <h3>UART Console</h3>
        <input type="text" id="uartInput" placeholder="Send text to RX..." style="width: 70%;">
        <button id="sendUartBtn">Send</button>
        <div id="console"></div>
    </div>

    <script>
        const SERVICE_UART = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
        const CHAR_RX = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";
        const CHAR_TX = "6e400003-b5a3-f393-e0a9-e50e24dcca9e";
        
        const SERVICE_BATT = 0x180F;
        const CHAR_BATT = 0x2A19;

        const CHAR_FREQ = "22e39003-05c2-498b-ad14-675b63720953";
        const CHAR_MODE = "22e39004-05c2-498b-ad14-675b63720953";
        const CHAR_ENERGY = "22e39005-05c2-498b-ad14-675b63720953";

        let device, server;
        let characteristics = {};

        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                log("Requesting device...");
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'Lume Frag 03' }],
                    optionalServices: [SERVICE_UART, SERVICE_BATT, "6e400001-b5a3-f393-e0a9-e50e24dcca9e"] 
                });

                log("Connecting to GATT Server...");
                server = await device.gatt.connect();
                document.getElementById('status').innerText = "Status: Connected";

                // Setup UART TX Notifications
                const uartSvc = await server.getPrimaryService(SERVICE_UART);
                characteristics.rx = await uartSvc.getCharacteristic(CHAR_RX);
                const tx = await uartSvc.getCharacteristic(CHAR_TX);
                await tx.startNotifications();
                tx.addEventListener('characteristicvaluechanged', handleUartNotify);

                // Setup Battery Notifications
                const battSvc = await server.getPrimaryService(SERVICE_BATT);
                const battChar = await battSvc.getCharacteristic(CHAR_BATT);
                await battChar.startNotifications();
                battChar.addEventListener('characteristicvaluechanged', (e) => {
                    document.getElementById('battLevel').innerText = e.target.value.getUint8(0);
                });

                // Fetch Mode Initial Value
                const freqSvc = await server.getPrimaryService(SERVICE_UART); // Assuming they share the UART service based on UUID patterns
                characteristics.freq = await freqSvc.getCharacteristic(CHAR_FREQ);
                characteristics.mode = await freqSvc.getCharacteristic(CHAR_MODE);
                characteristics.energy = await freqSvc.getCharacteristic(CHAR_ENERGY);

                log("Ready!");
            } catch (error) {
                log("Error: " + error);
            }
        });

        function handleUartNotify(event) {
            let value = new TextDecoder().decode(event.target.value);
            log("TX: " + value);
        }

        async function writeVal(type) {
            let val = document.getElementById(type + 'Input').value;
            let data = new Uint8Array([parseInt(val)]);
            await characteristics[type].writeValue(data);
            log("Sent " + type + ": " + val);
        }

        document.getElementById('sendUartBtn').addEventListener('click', async () => {
            let msg = document.getElementById('uartInput').value;
            let enc = new TextEncoder();
            await characteristics.rx.writeValue(enc.encode(msg));
            log("Sent RX: " + msg);
        });

        function log(msg) {
            const c = document.getElementById('console');
            c.innerHTML += msg + "<br>";
            c.scrollTop = c.scrollHeight;
        }
    </script>
</body>
</html>